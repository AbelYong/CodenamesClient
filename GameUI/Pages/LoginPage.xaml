<Page x:Class="CodenamesClient.GameUI.Pages.LoginPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:CodenamesClient.GameUI.Pages"
      xmlns:language="clr-namespace:CodenamesClient.Properties.Langs"
      xmlns:uc="clr-namespace:CodenamesClient.GameUI.Pages.UserControls"
      xmlns:viewmodels="clr-namespace:CodenamesClient.GameUI.ViewModels"
      d:DataContext="{d:DesignInstance Type=viewmodels:LoginViewModel}"
      mc:Ignorable="d" 
      d:DesignHeight="640" d:DesignWidth="1024" Background="#FF1D1D1D"
      Title="LoginPage">
    
    <!-- ===================== Resources (styles + animations) ===================== -->
    <Page.Resources>
        <uc:FirstErrorConverter x:Key="FirstErrorConverter"/>
        <Style x:Key="InlineLinkStyle" TargetType="TextBlock" BasedOn="{StaticResource normal}">
            <Setter Property="TextDecorations" Value="Underline"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <!-- Reset overlay entry animation -->
        <Storyboard x:Key="SlideInResetAnimation">
            <DoubleAnimation Storyboard.TargetName="ResetGrid"
                         Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)"
                         From="640" To="0" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>

        <!-- Reset overlay exit animation -->
        <Storyboard x:Key="SlideOutResetAnimation">
            <DoubleAnimation Storyboard.TargetName="ResetGrid"
                         Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)"
                         From="0" To="640" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseIn"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        <Style x:Key="ChecklistItemStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="Tomato"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Margin" Value="0,2,0,0"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Tag}" Value="True">
                    <Setter Property="Foreground" Value="LimeGreen"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <ControlTemplate x:Key="BelowTextValidationTemplate">
            <DockPanel LastChildFill="True">
                <TextBlock Margin="0,4,0,0" Foreground="Tomato" FontSize="12" TextWrapping="Wrap" DockPanel.Dock="Bottom"
                   Text="{Binding ElementName=adorner, Path=AdornedElement.(Validation.Errors), Converter={StaticResource FirstErrorConverter}}"/>
                <AdornedElementPlaceholder x:Name="adorner"/>
            </DockPanel>
        </ControlTemplate>
        <Style x:Key="ValidatedPasswordBox" TargetType="PasswordBox" BasedOn="{StaticResource passwordBoxCustomFocus}">
            <Setter Property="Validation.ErrorTemplate" Value="{StaticResource BelowTextValidationTemplate}"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Width" Value="360"/>
            <Style.Triggers>
                <Trigger Property="Validation.HasError" Value="True">
                    <Setter Property="BorderBrush" Value="Tomato"/>
                    <Setter Property="ToolTip"
                    Value="{Binding (Validation.Errors), RelativeSource={RelativeSource Self}, Converter={StaticResource FirstErrorConverter}}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Page.Resources>

    <!-- ===================== Content ===================== -->
    <Viewbox Stretch="Uniform">

        <Grid Width="1024" Height="640">
            <!-- ===== Login stack ===== -->
            <StackPanel x:Name="stackPanelLogin" HorizontalAlignment="Center" VerticalAlignment="Center" Width="808">
                <!-- Title -->
                <StackPanel Height="110" Orientation="Horizontal" HorizontalAlignment="Center">
                    <Label Content="Codenames:" Margin="0,0,0,0"  Foreground="White" FontFamily="Consolas" FontSize="72"/>
                    <Label Content="Duet" Margin="0,10,0,0" Foreground="White" FontSize="72" FontFamily="Bell MT"/>
                </StackPanel>

                <!-- User -->
                <Label Content="{x:Static language:Lang.globalUsername}" Style="{StaticResource subtitle}" Margin="0,0,0,10"/>
                <TextBox Name="tBxUsername" Style="{StaticResource textBoxCustomFocus}" Text="" Width="320" HorizontalContentAlignment="Center" MaxLength="20" />
                <Label Content="{Binding UsernameErrorMessage}" Style="{StaticResource normal}" Height="40" HorizontalContentAlignment="Center" Width="600"/>

                <Label Content="{x:Static language:Lang.loginPassword}" Style="{StaticResource subtitle}" Margin="0,0,0,10"/>
                <PasswordBox x:Name="pBxPassword" Style="{StaticResource passwordBoxCustomFocus}" HorizontalContentAlignment="Center" MaxLength="16" Width="320"/>
                <Label Content="{Binding PasswordErrorMessage}" Style="{StaticResource normal}" Height="40" HorizontalContentAlignment="Center" Width="600" />

                <!-- Reset password link -->
                <TextBlock Style="{StaticResource InlineLinkStyle}" Foreground="White"
                           VerticalAlignment="Center" MouseLeftButtonUp="ForgotLink_Click" Margin="0,0,0,10" Text="{x:Static language:Lang.loginForgotPassword}" />

                <!-- Action buttons -->
                <Button Click="Click_btnLogin"
                        IsEnabled="{Binding BtnLoginEnabled}"
                        Content="{x:Static language:Lang.loginLogIn}"
                        Style="{StaticResource buttonCustomFocus}"
                        Margin="0,0,0,10" Width="316" FontSize="24" Height="60"/>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,10">
                    <Label  Content="{x:Static language:Lang.loginDontHaveAccount}" Style="{StaticResource normal}" Margin="0,0,0,0"/>
                    <Button Click="Click_btnSignIn"  Content="{x:Static language:Lang.loginSignIn}" 
                            Style="{StaticResource buttonCustomFocus}"
                            Margin="0,0,0,0" FontFamily="Consolas" FontSize="16"
                            BorderBrush="#00000000" FontWeight="Normal" FontStyle="Italic" Width="107"/>
                </StackPanel>

                <Button Click="Click_btnPlayAsGuest"
                        IsEnabled="{Binding BtnSignInGuestEnabled}"
                        Content="{x:Static language:Lang.loginPlayAsGuest}"
                        Style="{StaticResource buttonCustomFocus}"
                        Margin="0,0,0,0" Height="60" Width="316" FontSize="24"/>
            </StackPanel>

            <Border x:Name="Overlay" Visibility="Collapsed" Background="#80000000" />
            <uc:SignInControl x:Name="SignInControl" Visibility="Collapsed" VerticalAlignment="Center" HorizontalAlignment="Center"
                              ClickClose="Click_SignInClose"/>

            <!-- ===== Backdrop ===== -->
            <Rectangle x:Name="ResetBackdrop" Fill="#80000000" Visibility="Collapsed" Panel.ZIndex="9"
                       HorizontalAlignment="Stretch" VerticalAlignment="Stretch" MouseLeftButtonUp="HideReset_Click"/>

            <!-- ===== Sliding overlay for password reset ===== -->
            <Grid x:Name="ResetGrid" Width="640" Height="470" Background="#272727" Visibility="Visible"
                  HorizontalAlignment="Center" VerticalAlignment="Center" Panel.ZIndex="10">
                <Grid.RenderTransform>
                    <TranslateTransform Y="640"/>
                </Grid.RenderTransform>

                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Label Grid.Row="0" Content="{x:Static language:Lang.resetTitle}"
                       Style="{StaticResource subtitle}"
                       Foreground="White"
                       HorizontalAlignment="Center"
                       Margin="0,10,0,16"/>

                    <StackPanel Grid.Row="1">
                        <TextBlock Text="{x:Static language:Lang.resetEmail}" Style="{StaticResource normal}" />
                        <TextBox x:Name="ResetEmail" Style="{StaticResource textBoxCustomFocus}" FontSize="16" Height="35" HorizontalContentAlignment="Center" Margin="0,2,0,12" MaxLength="30" Width="320"/>

                        <Button x:Name="SendCodeBtn" Content="{x:Static language:Lang.resetSendCode}"
                            Style="{StaticResource buttonCustomFocus}"
                            Click="SendCode_Click"
                            Width="316" Height="40" Margin="0,0,0,12"/>

                        <TextBlock Text="{x:Static language:Lang.resetReceivedCode}" Style="{StaticResource normal}" />
                        <TextBox x:Name="ResetCode" Style="{StaticResource textBoxCustomFocus}" HorizontalContentAlignment="Center" Margin="0,2,0,8" MaxLength="6" Width="320"/>
                        <TextBlock Text="{x:Static language:Lang.resetNewPassword}" Style="{StaticResource normal}" />
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <PasswordBox Grid.Column="0" uc:PasswordBoxHelper.BindPassword="True"
                                         uc:PasswordBoxHelper.BoundPassword="{Binding NewPassword, UpdateSourceTrigger=PropertyChanged, ValidatesOnNotifyDataErrors=True}"
                                         LostFocus="PasswordInput_LostFocus" FontSize="16"
                                         Style="{StaticResource ValidatedPasswordBox}" Margin="0,2,10,20" Height="30" Width="320" MaxLength="16" HorizontalAlignment="Right" HorizontalContentAlignment="Center" />
                            <Border Grid.Column="1" Margin="0,0,100,20" Background="#444" CornerRadius="15" Width="30" Height="30" Cursor="Hand" BorderBrush="Gray" BorderThickness="1" ToolTipService.InitialShowDelay="0" ToolTipService.ShowDuration="10000">
                                <TextBlock Text="?" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="White" FontWeight="Bold" FontSize="18"/>
                                <Border.ToolTip>
                                    <ToolTip Background="#222" BorderBrush="Gray" HasDropShadow="True">
                                        <StackPanel Margin="5">
                                            <TextBlock Text="{x:Static language:Lang.signInPasswordRequirements}" FontWeight="Bold" Foreground="White" Margin="0,0,0,5"/>
                                            <TextBlock Style="{StaticResource ChecklistItemStyle}" Tag="{Binding PwHasMinLength}" Text="{Binding PwMinLengthText}"/>
                                            <TextBlock Style="{StaticResource ChecklistItemStyle}" Tag="{Binding PwWithinMaxLength}" Text="{Binding PwMaxLengthText}"/>
                                            <TextBlock Style="{StaticResource ChecklistItemStyle}" Tag="{Binding PwHasUpper}" Text="{x:Static language:Lang.signInPasswordAtLeastOneUppercaseLetter}"/>
                                            <TextBlock Style="{StaticResource ChecklistItemStyle}" Tag="{Binding PwHasLower}" Text="{x:Static language:Lang.signInPasswordAtLeastOneLowercaseLetter}"/>
                                            <TextBlock Style="{StaticResource ChecklistItemStyle}" Tag="{Binding PwHasDigit}" Text="{x:Static language:Lang.signInPasswordAtLeastOneDigit}"/>
                                            <TextBlock Style="{StaticResource ChecklistItemStyle}" Tag="{Binding PwHasSpecial}" Text="{x:Static language:Lang.signInPasswordAtLeastOneSpecialCharacter}"/>
                                        </StackPanel>
                                    </ToolTip>
                                </Border.ToolTip>
                            </Border>
                        </Grid>

                        <TextBlock Text="{x:Static language:Lang.signInConfirmPassword}" Style="{StaticResource normal}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <PasswordBox Grid.Column="0" uc:PasswordBoxHelper.BindPassword="True"
                                         uc:PasswordBoxHelper.BoundPassword="{Binding ConfirmPassword, UpdateSourceTrigger=PropertyChanged, ValidatesOnNotifyDataErrors=True, NotifyOnValidationError=True}"
                                         Style="{StaticResource ValidatedPasswordBox}"
                                         Margin="0,2,140,20" Width="320" Height="30" MaxLength="16" HorizontalAlignment="Right" HorizontalContentAlignment="Center" />
                        </Grid>
                    </StackPanel>

                    <Grid Grid.Row="2" Margin="0,14,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition />
                            <ColumnDefinition />
                        </Grid.ColumnDefinitions>
                        <Button Grid.Column="0" Content="{x:Static language:Lang.globalBack}"
                            Style="{StaticResource buttonCustomFocus}"
                            Width="180" Height="40" Click="HideReset_Click"/>
                        <Button Grid.Column="1" Content="{x:Static language:Lang.resetChangePassword}" IsEnabled="{Binding CanSubmit}"
                            Style="{StaticResource buttonCustomFocus}"
                            Width="180" Height="40" Click="ConfirmReset_Click"/>
                    </Grid>
                </Grid>
            </Grid>
        </Grid>
    </Viewbox>
</Page>